initContainers:
  # ===========================================
  # 1. MinIO → コンテナ内 /tmp へダウンロード
  # ===========================================
  - name: sync-mods-config
    image: bitnami/minideb:bookworm
    securityContext:
      runAsUser: 0
    env:
      - name: MINIO_URL
        value: "https://minio.example.com"
      - name: MINIO_BUCKET
        value: "minecraft-mods/fabric-hardcore-smp"
      - name: MINIO_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: minio-secret
            key: accesskey
      - name: MINIO_SECRET_KEY
        valueFrom:
          secretKeyRef:
            name: minio-secret
            key: secretkey
    command:
      - /bin/bash
      - -c
      - |
        set -e

        echo "[sync] Installing mc client..."
        apt-get update -y && apt-get install -y curl ca-certificates jq
        curl -fsSL https://dl.min.io/client/mc/release/linux-amd64/mc -o /usr/local/bin/mc
        chmod +x /usr/local/bin/mc

        echo "[sync] Setting mc alias..."
        mc alias set minio "${MINIO_URL}" "${MINIO_ACCESS_KEY}" "${MINIO_SECRET_KEY}"

        echo "[sync] Downloading mods/config..."
        mc mirror --overwrite minio/${MINIO_BUCKET}/mods/ /tmp/mods/
        mc mirror --overwrite minio/${MINIO_BUCKET}/config/ /tmp/config/

        echo "[sync] Fixing permissions..."
        chown -R 1000:1000 /tmp/mods /tmp/config

    volumeMounts:
      - name: tmp-sync
        mountPath: /tmp


  # ===========================================
  # 2. /tmp → /data へ反映（rsyncで差分コピ）
  # ===========================================
  - name: rsync-mods-config
    image: bitnami/minideb:bookworm
    securityContext:
      runAsUser: 0
    command:
      - /bin/bash
      - -c
      - |
        set -e
        apt-get update -y && apt-get install -y rsync

        echo "[rsync] Syncing /tmp → /data"
        rsync -av --delete /tmp/mods/ /data/mods/
        rsync -av --delete /tmp/config/ /data/config/

        chown -R 1000:1000 /data/mods /data/config

    volumeMounts:
      - name: data
        mountPath: /data
      - name: tmp-sync
        mountPath: /tmp


  # ===========================================
  # 3. OpenCL ICD / libOpenCL.so setup
  # ===========================================
  - name: link-opencl
    image: bitnami/minideb:bookworm
    securityContext:
      runAsUser: 0
    command:
      - /bin/bash
      - -c
      - |
        set -e
        apt-get update -y && apt-get install -y curl ca-certificates

        echo "[icl] Ensuring /etc/OpenCL/vendors exists..."
        mkdir -p /etc/OpenCL/vendors

        echo "[icl] Generating ICD file..."
        echo "/usr/lib64/libOpenCL.so.1" > /etc/OpenCL/vendors/nvidia.icd

        echo "[icl] Verifying..."
        cat /etc/OpenCL/vendors/nvidia.icd

    volumeMounts:
      - name: nvidia-libopencl
        mountPath: /usr/lib64/libOpenCL.so.1
        readOnly: true


# ===========================================
# Volumes (Deployment で定義する例)
# ===========================================
volumes:
  - name: data
    persistentVolumeClaim:
      claimName: minecraft-data-pvc

  - name: tmp-sync
    emptyDir: {}

  - name: nvidia-libopencl
    hostPath:
      path: /usr/lib64/libOpenCL.so.1
      type: File
